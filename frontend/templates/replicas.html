{% extends "base.html" %}

{% block title %}Replicas - Spot Optimizer{% endblock %}

{% block content %}
<div x-data="replicasData()" x-init="init()">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Replicas</h1>
        <div class="space-x-2">
            <button @click="fetchReplicas()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Refresh</button>
            <button @click="showCreateModal = true" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Replica</button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Replica ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Instance</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pool</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cost</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <template x-for="replica in replicas" :key="replica.id">
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-mono text-sm" x-text="replica.id.substring(0, 8) + '...'"></td>
                        <td class="px-6 py-4 font-mono text-sm" x-text="replica.instance_id"></td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded"
                                  :class="replica.replica_type === 'emergency' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'"
                                  x-text="replica.replica_type"></span>
                        </td>
                        <td class="px-6 py-4 text-sm" x-text="replica.pool_id"></td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded"
                                  :class="{
                                      'bg-green-100 text-green-700': replica.status === 'ready',
                                      'bg-yellow-100 text-yellow-700': replica.status === 'launching' || replica.status === 'syncing',
                                      'bg-purple-100 text-purple-700': replica.status === 'promoting',
                                      'bg-gray-100 text-gray-700': replica.status === 'terminated'
                                  }"
                                  x-text="replica.status"></span>
                        </td>
                        <td class="px-6 py-4 text-sm">$<span x-text="(replica.hourly_cost || 0).toFixed(4)"></span>/hr</td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button @click="promoteReplica(replica)"
                                        x-show="replica.status === 'ready'"
                                        class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                    Promote
                                </button>
                                <button @click="terminateReplica(replica)"
                                        x-show="replica.status !== 'terminated'"
                                        class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    Terminate
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
        <div x-show="replicas.length === 0" class="p-8 text-center text-gray-500">No active replicas</div>
    </div>

    <!-- Create Replica Modal -->
    <div x-show="showCreateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Create Replica</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Agent</label>
                    <select x-model="createForm.agent_id" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">Select an agent</option>
                        <template x-for="agent in agents" :key="agent.id">
                            <option :value="agent.id" x-text="agent.hostname || agent.instance_id"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Pool (AZ)</label>
                    <input type="text" x-model="createForm.target_pool_id" placeholder="e.g., t3.medium.us-east-1a" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button @click="showCreateModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button @click="createReplica()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function replicasData() {
    return {
        replicas: [],
        agents: [],
        showCreateModal: false,
        createForm: { agent_id: '', target_pool_id: '' },

        async init() {
            await Promise.all([this.fetchReplicas(), this.fetchAgents()]);
        },

        async fetchReplicas() {
            try {
                const response = await fetch('/api/replicas');
                const data = await response.json();
                this.replicas = data.replicas || [];
            } catch (error) {
                console.error('Failed to fetch replicas:', error);
            }
        },

        async fetchAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                this.agents = data.agents || [];
            } catch (error) {
                console.error('Failed to fetch agents:', error);
            }
        },

        async createReplica() {
            try {
                await fetch(`/api/agents/${this.createForm.agent_id}/replicas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_pool_id: this.createForm.target_pool_id })
                });
                this.showCreateModal = false;
                this.fetchReplicas();
            } catch (error) {
                console.error('Failed to create replica:', error);
            }
        },

        async promoteReplica(replica) {
            if (!confirm('Are you sure you want to promote this replica to primary?')) return;
            try {
                await fetch(`/api/agents/${replica.agent_id}/replicas/${replica.id}/promote`, { method: 'POST' });
                this.fetchReplicas();
            } catch (error) {
                console.error('Failed to promote replica:', error);
            }
        },

        async terminateReplica(replica) {
            if (!confirm('Are you sure you want to terminate this replica?')) return;
            try {
                await fetch(`/api/agents/${replica.agent_id}/replicas/${replica.id}`, { method: 'DELETE' });
                this.fetchReplicas();
            } catch (error) {
                console.error('Failed to terminate replica:', error);
            }
        }
    }
}
</script>
{% endblock %}
